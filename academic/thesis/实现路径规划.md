# 论文实现路径规划

> **目标**：完成"工具调用 + GraphRAG + 后训练"三位一体框架的设计、实现与验证
> **周期**：预计 6-8 周

---

## 阶段概览

```
Week 1-2          Week 3-4          Week 5-6          Week 7-8
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│ 阶段一  │ ───▶ │ 阶段二  │ ───▶ │ 阶段三  │ ───▶ │ 阶段四  │
│ 基础完善 │      │ 工具调用 │      │ 后训练  │      │ 评估+论文│
└─────────┘      └─────────┘      └─────────┘      └─────────┘
```

---

## 阶段一：GraphRAG 基础完善（Week 1-2）

### 1.1 已完成 ✅
- [x] 嵌入模块 `embedding.py`：API/本地模型抽象
- [x] 向量存储 `vector_store.py`：FAISS + 元数据过滤
- [x] 检索模块 `retrieve.py`：混合检索 + RRF + 图扩展
- [x] 更新模块 `updater.py`：在线热更新
- [x] API 端点：`/v1/chat/hybrid`、`/v1/graphrag/index`
- [x] 引导式学习端点 `/v1/chat/guided`：学习路径生成 + 步骤追踪
- [x] **学习状态分析模块** 🆕
  - `weak_point_detector.py`：NLP 薄弱点检测（50+ 电磁场概念词库）
  - `student_profile.py`：学生档案数据结构 + 后端同步客户端
  - `coaching_strategy.py`：个性化辅导策略生成技能
  - Go 模型 `StudentLearningProfile`：数据库持久化

### 1.2 待完成
- [ ] **引用追溯功能**
  - 在 AI 回答中插入引用标注 `[1][2]`
  - 返回引用片段列表供前端展示
  - 修改 `main.py` 和 `skills/` 目录中的 system prompt

- [ ] **多源数据索引**
  - 支持作业提交自动索引
  - 支持讨论帖/FAQ 索引
  - 扩展 `updater.py` 新增 `add_assignment`、`add_discussion` 方法

- [ ] **前端集成**
  - 聊天页面切换到 `/v1/chat/hybrid`
  - 展示引用来源折叠面板
  - 引导式学习进度面板（展示学习路径、薄弱点）

- [ ] **学生档案 API**
  - Go 后端 `/api/v1/learning-profiles` CRUD
  - AI 服务和后端联调

### 1.3 交付物
| 交付物 | 验收标准 |
|--------|----------|
| 引用追溯 | 回答包含 `[1]` 标注，点击可展开原文 |
| 多源索引 | 作业提交后 5s 内可被检索 |
| 前端集成 | 聊天界面正常使用混合检索 |
| 薄弱点检测 🆕 | 学习会话中自动识别并记录薄弱点 |
| 辅导策略 🆕 | 基于学习档案生成个性化建议 |

---

## 阶段二：工具调用实现（Week 3-4）

### 2.1 核心任务

- [ ] **工具定义与注册**
  ```python
  # tools.py
  TOOLS = [
      {
          "name": "calculate_expression",
          "description": "计算数学表达式或物理公式",
          "parameters": {...}
      },
      {
          "name": "run_simulation",
          "description": "运行电磁场仿真",
          "parameters": {...}
      }
  ]
  ```

- [ ] **工具执行器**
  - `SymPy` 符号计算
  - 仿真服务调用封装
  - 安全沙箱（限制危险操作）

- [ ] **工具调用流程**
  ```
  用户问题 → LLM判断 → 调用工具 → 获取结果 → LLM生成回答
  ```

- [ ] **证据链 + 计算链融合**
  - 回答同时标注 `[引用1]` 和 `[计算结果]`
  - 结构化输出：`{"answer": "...", "citations": [...], "tool_results": [...]}`

### 2.2 工具列表

| 工具名 | 功能 | 输入示例 | 输出示例 |
|--------|------|----------|----------|
| `calculate_expression` | 符号/数值计算 | `ε₀ * μ₀` | `1/(c²)` |
| `solve_equation` | 求解方程 | `∇²V = 0, BC=...` | `V(r,θ) = ...` |
| `run_simulation` | 运行仿真 | `laplace2d, grid=50` | `图像URL + 数据` |
| `query_formula` | 公式查询 | `电磁波波阻抗` | `η = √(μ/ε)` |

### 2.3 交付物
| 交付物 | 验收标准 |
|--------|----------|
| tools.py | 4 个核心工具可调用 |
| 工具执行器 | `calculate_expression` 正确计算物理常数 |
| 端到端流程 | 问"计算铜的趋肤深度"能调用工具并返回结果 |

---

## 阶段三：后训练与领域适配（Week 5-6）

### 3.1 数据集构建

- [ ] **教学问答数据集**（目标 500+ 条）
  - 概念解释类：100 条
  - 公式推导类：100 条
  - 习题引导类：100 条
  - 工具调用类：100 条
  - 仿真解读类：100 条

- [ ] **数据格式**
  ```json
  {
    "instruction": "请解释电磁场边界条件",
    "input": "",
    "output": "电磁场边界条件描述了...\n\n**切向分量**：...\n\n参考 [1] 第二章"
  }
  ```

- [ ] **工具调用数据**
  ```json
  {
    "instruction": "计算频率 1GHz 时铜的趋肤深度",
    "input": "",
    "output": "<tool_call>{\"name\": \"calculate_expression\", \"args\": {...}}</tool_call>\n\n根据计算，δ ≈ 2.1μm"
  }
  ```

### 3.2 LoRA 微调

- [ ] **环境准备**
  - 基座模型：Qwen2.5-7B-Instruct
  - 框架：LLaMA-Factory 或 PEFT
  - 硬件：单 GPU (16GB+)

- [ ] **训练配置**
  ```python
  lora_config = {
      "r": 16,
      "lora_alpha": 32,
      "target_modules": ["q_proj", "v_proj"],
      "lora_dropout": 0.05
  }
  ```

- [ ] **训练流程**
  1. 数据预处理 → Alpaca 格式
  2. LoRA 微调 2-3 epochs
  3. 合并/导出适配器
  4. 部署测试

### 3.3 交付物
| 交付物 | 验收标准 |
|--------|----------|
| 数据集 | 500+ 条高质量问答对 |
| LoRA 适配器 | 可加载到 Qwen 推理 |
| A/B 测试 | 微调后教学质量提升（人工评分） |

---

## 阶段四：评估与论文撰写（Week 7-8）

### 4.1 评估基准构建

- [ ] **基准查询集**（50 条）
  - 概念类：15 条
  - 推导类：15 条
  - 计算类：15 条
  - 综合类：5 条

- [ ] **标注规范**
  - 标准答案
  - 关键引用片段
  - 预期工具调用

### 4.2 消融实验

| 配置 | 工具调用 | GraphRAG | 后训练 |
|------|:--------:|:--------:|:------:|
| Baseline | ✗ | ✗ | ✗ |
| +RAG | ✗ | ✓ | ✗ |
| +Tool | ✓ | ✗ | ✗ |
| +RAG+Tool | ✓ | ✓ | ✗ |
| **Full** | ✓ | ✓ | ✓ |

### 4.3 评估指标

| 维度 | 指标 | 计算方式 | 目标阈值 |
|------|------|----------|----------|
| 检索质量 | Recall@5 | 标准引用在 Top5 中的比例 | >=0.60 |
| 引用正确率 | Citation Acc | 回答引用与检索片段一致 | >=0.85 |
| 计算正确率 | Tool Acc | 工具调用结果正确（仅统计触发样本） | >=0.90 |
| 幻觉率 | Hallucination% | 与标准答案不一致的比例 | <=0.15 |
| 教学质量 | Human Score (1-5) | 准确性 + 清晰度 + 教学性 | >=4.0/5 |
| 覆盖率 | Coverage% | 核心模块单元测试行覆盖率 | >=0.60 |
| 性能 | p95 响应时间 | 端到端对话响应时间 | <=10s |
| 稳定性 | 用例通过率 | 关键用例脚本成功率 | >=0.95 |

### 4.4 论文撰写

| 章节 | 内容 | 字数 |
|------|------|------|
| 第一章 | 绪论 | 5000 |
| 第二章 | 相关技术 | 6000 |
| 第三章 | 系统设计 | 4000 |
| **第四章** | **智能辅助推理系统**（核心）| 10000 |
| 第五章 | 教学管理模块 | 5000 |
| 第六章 | AI 辅助模块 | 5000 |
| 第七章 | 仿真子系统 | 4000 |
| 第八章 | 测试与评估 | 5000 |
| 第九章 | 结论 | 2000 |

### 4.5 交付物
| 交付物 | 验收标准 |
|--------|----------|
| 评估报告 | 5 种配置消融对比表 |
| 论文初稿 | 4.6 万字，结构完整 |
| 演示视频 | 3-5 分钟核心功能演示 |

---

## 风险与应对

| 风险 | 概率 | 应对措施 |
|------|------|----------|
| LoRA 效果不佳 | 中 | 增加数据集规模；尝试 QLoRA 或 DoRA |
| 工具调用不稳定 | 中 | 增加错误处理；fallback 到纯 RAG |
| 评估数据不足 | 低 | 邀请同学/老师帮助标注 |
| 时间紧张 | 中 | 优先保证核心功能，后训练可简化 |

---

## 里程碑检查点

| 日期 | 里程碑 | 产出 |
|------|--------|------|
| Week 2 | GraphRAG 完善 | 引用追溯 + 多源索引 |
| Week 4 | 工具调用完成 | 4 个工具可用 |
| Week 6 | 后训练完成 | LoRA 适配器 + 500 条数据 |
| Week 8 | 评估 + 论文 | 消融报告 + 论文初稿 |

---

## 下一步行动（本周）

1. [x] 实现薄弱点检测：`weak_point_detector.py` 已完成
2. [x] 学生档案持久化：`student_profile.py` + Go 模型已完成
3. [x] 个性化辅导：`coaching_strategy.py` 技能已完成
4. [ ] Go 后端 `/api/v1/learning-profiles` API 实现
5. [ ] 引用追溯：修改 prompt 添加引用标注
6. [ ] 开始收集教学问答数据：从课程 FAQ 和往年作业中提取
