name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set image namespace
        id: images
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24.x"
          cache-dependency-path: code/backend/go.sum

      - name: Build backend binaries
        working-directory: code/backend
        env:
          GOPROXY: https://goproxy.cn,direct
        run: |
          rm -rf dist
          mkdir -p dist ../../release
          for arch in amd64 arm64; do
            CGO_ENABLED=0 GOOS=linux GOARCH=$arch go build -o dist/server ./cmd/server
            tar -czf ../../release/backend-linux-$arch.tar.gz -C dist server
          done

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build frontend
        working-directory: code/frontend-react
        run: |
          npm install --no-audit --no-fund
          npm run build
          tar -czf ../../release/frontend-dist.tar.gz -C dist .

      - name: Get previous tag
        id: previoustag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        run: |
          mkdir -p release
          if [ -z "${{ steps.previoustag.outputs.PREV_TAG }}" ]; then
            git log --pretty=format:"- %s (%h)" > release/CHANGELOG.md
          else
            git log ${{ steps.previoustag.outputs.PREV_TAG }}..HEAD --pretty=format:"- %s (%h)" > release/CHANGELOG.md
          fi
          {
            echo "# Release v${{ steps.version.outputs.VERSION }}"
            echo ""
            echo "## Changes"
            echo ""
            cat release/CHANGELOG.md
          } > release/CHANGELOG_FINAL.md
          mv release/CHANGELOG_FINAL.md release/CHANGELOG.md

      - name: Generate checksums
        run: |
          cd release
          sha256sum * > checksums.txt

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./code/backend
          file: ./code/backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-backend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-backend:latest
          platforms: linux/amd64,linux/arm64

      - name: Build and push AI service image
        uses: docker/build-push-action@v5
        with:
          context: ./code/ai_service
          file: ./code/ai_service/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-ai:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-ai:latest
          platforms: linux/amd64,linux/arm64

      - name: Build and push simulation image
        uses: docker/build-push-action@v5
        with:
          context: ./code/simulation
          file: ./code/simulation/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-sim:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-sim:latest
          platforms: linux/amd64,linux/arm64

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./code/frontend-react
          file: ./code/frontend-react/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-frontend:${{ steps.version.outputs.VERSION }}
            ghcr.io/${{ steps.images.outputs.OWNER_LC }}/emfield-frontend:latest
          platforms: linux/amd64,linux/arm64

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release/CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            release/backend-linux-amd64.tar.gz
            release/backend-linux-arm64.tar.gz
            release/frontend-dist.tar.gz
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy (SSH)
        if: secrets.PROD_HOST != '' && secrets.PROD_USER != '' && secrets.PROD_SSH_KEY != '' && secrets.DEPLOY_PATH != ''
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          port: ${{ secrets.PROD_PORT }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          script_stop: true
          script: |
            export APP_VERSION=${{ steps.version.outputs.VERSION }}
            export IMAGE_REGISTRY=ghcr.io
            export IMAGE_NAMESPACE=${{ steps.images.outputs.OWNER_LC }}
            cd ${{ secrets.DEPLOY_PATH }}
            docker-compose -f code/deployment/docker/docker-compose.prod.yml pull
            docker-compose -f code/deployment/docker/docker-compose.prod.yml up -d
