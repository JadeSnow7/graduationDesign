[supervisord]
nodaemon=true
user=appuser
logfile=/var/log/supervisor/supervisord.log
pidfile=/tmp/supervisord.pid
childlogdir=/var/log/supervisor

# =============================================================================
# Simulation Service (Python/FastAPI)
# =============================================================================
[program:sim]
command=python -m uvicorn app.main:app --host 0.0.0.0 --port 8002 --workers 1
directory=/app/simulation
autostart=%(ENV_SIM_ENABLED)s
autorestart=true
startsecs=10
startretries=3
exitcodes=0,2
priority=10
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=PYTHONUNBUFFERED="1",MPLBACKEND="Agg"

# =============================================================================
# AI Service (Python/FastAPI) - Optional
# =============================================================================
[program:ai]
command=python -m uvicorn app.main:app --host 0.0.0.0 --port 8001 --workers 1
directory=/app/ai_service
autostart=%(ENV_AI_ENABLED)s
autorestart=true
startsecs=10
startretries=3
exitcodes=0,2
priority=20
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=PYTHONUNBUFFERED="1"

# =============================================================================
# Go Backend
# =============================================================================
[program:backend]
command=/app/backend
directory=/app
autostart=true
autorestart=true
startsecs=5
startretries=3
exitcodes=0
priority=30
stopasgroup=true
killasgroup=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# Event Listener for Fatal Failures
# Restart container if critical service fails
# =============================================================================
[eventlistener:process_exit]
command=/bin/sh -c "echo 'READY' && while read line; do echo 'RESULT 2\nOK' && kill -TERM 1; done"
events=PROCESS_STATE_FATAL
buffer_size=10
